[tox]
envlist = 
    begincoverage,py{37,38,39}-dj{22,30,31,32}-{standard,djangocte},endcoverage,lint
skip_missing_interpreters = true

[base]
deps=
    dj22: Django>=2.2,<3.0
    dj30: Django>=3.0,<3.1
    dj31: Django>=3.1,<3.2
    dj32: Django>=3.2,<3.3
    django-delayed-union
    flake8
    coverage
    deprecated

[testenv]
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/tests/unit
commands =
    standard: coverage run --append {envdir}/bin/django-admin test --settings tests.unit.settings.standard testapp.tests
    djangocte: coverage run --append {envdir}/bin/django-admin test --settings tests.unit.settings.djangocte testapp.tests

deps=
    {[base]deps}
    djangocte: django-cte==1.1.5

[testenv:begincoverage]
deps=coverage
commands = coverage erase

[testenv:endcoverage]
deps=coverage
commands =
    coverage report --omit='.tox/*'
    coverage html --omit='.tox/*'

[testenv:docs]
description = invoke sphinx-build to build the HTML docs
basepython = python
changedir = docs
deps =
    Sphinx
    Django
    deprecated
    django-cte==1.1.5
    sphinx_issues
commands =
    sphinx-apidoc -o apidocs ../django_dag
    sphinx-build -d "{toxworkdir}/docs_doctree" . "{toxworkdir}/docs_out" --color -W -bhtml {posargs}
    python -c 'import pathlib; print("documentation available under file://\{0\}".format(pathlib.Path(r"{toxworkdir}") / "docs_out" / "index.html"))'

[testenv:lint]
skip_install = true
deps = flake8
commands = flake8

[flake8]
exclude = .tox,.git,__pycache__,.eggs,
ignore =
    # Ignore "and" / "or" at start of line.
    W503
    W504
    # Ignore "do not assign a lambda expression, use a def".
    E731
    E121
    E128
    E126
max-line-length = 120
